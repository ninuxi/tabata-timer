<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Timer professionale per allenamenti Tabata HIIT - Programmabile e personalizzabile">
    <meta name="theme-color" content="#00ff00">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Tabata Timer">
    <link rel="manifest" href="manifest.json">
    <title>⏱️ Tabata Timer</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Impact', 'Arial Black', 'Bebas Neue', 'Oswald', sans-serif;
            text-align: center;
            background: #ff6b35;
            color: white;
            padding: 10px;
            margin: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container {
            width: 100%;
            max-width: 420px;
            background: #000000;
            padding: 25px 20px;
            border-radius: 25px;
            border: 3px solid #ffd700;
        }
        h1 {
            color: #ffff00;
            margin-bottom: 25px;
            font-size: 1.8rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 3px;
        }
        .controls {
            margin: 20px 0;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
        }
        .control-group {
            background: #000000;
            padding: 15px 12px;
            border-radius: 15px;
            border: 2px solid #00ff00;
        }
        .control-group label {
            display: block;
            font-size: 0.9rem;
            margin-bottom: 8px;
            font-weight: 700;
            color: #ffff00;
        }
        input {
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            border: 2px solid #ff6b35;
            background: #000000;
            color: #ffff00;
            font-size: 1.1rem;
            font-weight: 900;
            text-align: center;
        }
        input:focus {
            outline: none;
            border-color: #ffff00;
        }
        .preset-container, .group-body {
            margin: 10px 0 0;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }
        .preset-btn, button, .link-chip {
            padding: 12px 20px;
            font-size: 0.9rem;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 900;
            background: #ffd700;
            color: #000000;
            border: 2px solid #00ff00;
            text-transform: uppercase;
        }
        .preset-btn:hover, button:hover, .link-chip:hover {
            background: #00ff00;
            transform: translateY(-3px) scale(1.05);
            border-color: #ff6b35;
        }
        #startBtn {
            background: #00ff00;
            color: #000000;
            font-size: 1.1rem;
            padding: 18px 40px;
            margin: 15px 8px;
            width: auto;
            min-width: 140px;
            border: 3px solid #ffff00;
            font-weight: 900;
            text-transform: uppercase;
        }
        #stopBtn {
            background: #ff6b35;
            color: #000000;
            font-size: 1.1rem;
            padding: 18px 40px;
            margin: 15px 8px;
            width: auto;
            min-width: 140px;
            border: 3px solid #ffff00;
            font-weight: 900;
            text-transform: uppercase;
        }
        #timer {
            font-size: 4.5rem;
            margin: 25px 0;
            font-weight: 900;
            line-height: 1;
            text-transform: uppercase;
            letter-spacing: 3px;
        }
        #round, #status {
            font-size: 1.3rem;
            margin: 15px 0;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .work { 
            color: #ff6b35; 
            animation: pulse 1s infinite;
        }
        .rest { 
            color: #00ff00; 
            animation: pulse 1s infinite;
        }
        .work.flash-warning {
            animation: pulse 1s infinite, flashWork 0.5s infinite;
        }
        .rest.flash-warning {
            animation: pulse 1s infinite, flashRest 0.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        @keyframes flashWork {
            0%, 100% { background: rgba(255, 107, 53, 0.1); }
            50% { background: rgba(255, 107, 53, 0.3); }
        }
        @keyframes flashRest {
            0%, 100% { background: rgba(0, 255, 0, 0.1); }
            50% { background: rgba(0, 255, 0, 0.3); }
        }
        
        /* Volume Control */
        .volume-control {
            margin: 15px 0;
            padding: 12px;
            background: #000;
            border: 2px solid #00ff00;
            border-radius: 15px;
        }
        .volume-control label {
            display: block;
            font-size: 0.8rem;
            margin-bottom: 8px;
            color: #ffd700;
            font-weight: 700;
        }
        .volume-slider {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: #333;
            border-radius: 5px;
            outline: none;
        }
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #ffd700;
            border: 2px solid #00ff00;
            border-radius: 50%;
            cursor: pointer;
        }
        .volume-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #ffd700;
            border: 2px solid #00ff00;
            border-radius: 50%;
            cursor: pointer;
        }
        
        /* Settings Toggle */
        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 8px 0;
            font-size: 0.8rem;
        }
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #333;
            transition: .3s;
            border-radius: 24px;
            border: 2px solid #666;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: #00ff00;
            border-color: #00ff00;
        }
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        /* Fullscreen button */
        .fullscreen-btn {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #ffd700;
            color: #ffd700;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            z-index: 1000;
            font-weight: 700;
        }
        .fullscreen-btn:hover {
            background: #ffd700;
            color: #000;
        }
        
        /* Keyboard shortcuts hint */
        .shortcuts-hint {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: #888;
            padding: 6px 10px;
            border-radius: 10px;
            font-size: 0.65rem;
            z-index: 1000;
            display: none;
        }
        .shortcuts-hint.visible {
            display: block;
        }
        /* Accordion panels */
        details.panel {
            background:#000000;
            border:2px solid #00ff00;
            border-radius:22px;
            padding:14px 16px 12px;
            margin:14px 0;
        }
        details.panel[open] { border-color:#ffd700; }
        details.panel summary {
            list-style:none;
            cursor:pointer;
            font-weight:900;
            letter-spacing:2px;
            font-size:0.8rem;
            color:#ffff00;
            display:flex;
            align-items:center;
            gap:8px;
            text-transform:uppercase;
        }
        details.panel summary::-webkit-details-marker { display:none; }
        details.panel summary:before {
            content:'▸';
            display:inline-block;
            transform:rotate(0deg);
            transition:transform .25s ease;
            font-size:0.9rem;
            color:#00ff00;
        }
        details.panel[open] summary:before { transform:rotate(90deg); }
        .chip-links { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-top:10px; }
        .link-chip { text-decoration:none; display:inline-block; }
        .link-chip.highlight { 
            background: linear-gradient(135deg, #ffd700 0%, #ffA500 100%); 
            color: #000; 
            font-weight: 900; 
            font-size: 0.95rem;
            border: 3px solid #00ff00;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .install-btn {
            background: linear-gradient(135deg, #00ff00 0%, #00cc00 100%);
            color: #000;
            border: 2px solid #ffd700;
            font-weight: 900;
            margin: 15px 0;
            padding: 14px 24px;
            font-size: 0.85rem;
            border-radius: 25px;
            cursor: pointer;
            display: none;
            box-shadow: 0 4px 15px rgba(0, 255, 0, 0.3);
        }
        .install-btn:hover {
            background: linear-gradient(135deg, #ffd700 0%, #ffA500 100%);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.5);
        }
        .music-links a { text-decoration:none; }
        .music-links { display:flex; flex-wrap:wrap; gap:6px; justify-content:center; margin-top:10px; }
        .music-links a { background:#111; color:#ffd700; padding:8px 14px; border-radius:18px; font-size:0.7rem; font-weight:700; border:2px solid #00ff00; letter-spacing:1px; text-transform:uppercase; }
        .music-links a:hover { background:#00ff00; color:#000; border-color:#ff6b35; transform:translateY(-2px); }
        @media (max-width:480px){
            details.panel { padding:12px 14px 10px; }
            details.panel summary { font-size:0.7rem; }
            .preset-btn, button, .link-chip { font-size:0.75rem; padding:10px 14px; }
            .music-links a { font-size:0.6rem; padding:6px 10px; }
        }
        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            .container {
                padding: 20px 15px;
                border-radius: 20px;
                margin: 10px;
            }
            h1 {
                font-size: 1.5rem;
                margin-bottom: 20px;
            }
            .controls {
                grid-template-columns: 1fr;
                gap: 10px;
                margin: 15px 0;
            }
            .control-group {
                padding: 12px 10px;
            }
            .control-group label {
                font-size: 0.85rem;
            }
            input {
                padding: 10px;
                font-size: 1rem;
            }
            .preset-container {
                gap: 6px;
                margin: 15px 0;
            }
            .preset-btn, button {
                font-size: 0.8rem;
                padding: 10px 16px;
            }
            #timer {
                font-size: 3rem;
                margin: 20px 0;
            }
            #round, #status {
                font-size: 1.1rem;
                margin: 12px 0;
            }
            #startBtn, #stopBtn {
                font-size: 1rem;
                padding: 15px 30px;
                margin: 10px 5px;
                width: calc(50% - 10px);
                min-width: unset;
            }
        }

        /* Update Notification Modal */
        .update-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .update-modal.show {
            display: flex;
        }
        .update-content {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            border: 3px solid #00ff00;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 255, 0, 0.3);
        }
        .update-content h2 {
            color: #00ff00;
            margin: 0 0 15px;
            font-size: 1.8rem;
            letter-spacing: 2px;
        }
        .update-content p {
            color: #fff;
            margin: 15px 0;
            line-height: 1.6;
            font-family: Arial, sans-serif;
            font-size: 1rem;
        }
        .update-content .shortcut {
            background: #000;
            border: 2px solid #ffd700;
            padding: 15px;
            border-radius: 12px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 1.1rem;
            color: #ffd700;
            font-weight: bold;
        }
        .update-content .browser-info {
            background: #0a0a0a;
            border: 1px solid #333;
            padding: 10px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: Arial, sans-serif;
            font-size: 0.9rem;
            color: #aaa;
        }
        .update-content button {
            background: #00ff00;
            color: #000;
            border: 2px solid #ffd700;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            margin: 10px 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .update-content button:hover {
            background: #ffd700;
            transform: scale(1.05);
        }
        .update-content button.secondary {
            background: #333;
            color: #fff;
            border-color: #666;
        }
        .update-content button.secondary:hover {
            background: #555;
        }

        /* Install Instructions Modal */
        .install-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-y: auto;
        }
        .install-modal.show {
            display: flex;
        }
        .install-content {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            border: 3px solid #ffd700;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            text-align: left;
            box-shadow: 0 10px 40px rgba(255, 215, 0, 0.3);
            max-height: 90vh;
            overflow-y: auto;
        }
        .install-content h2 {
            color: #ffd700;
            margin: 0 0 20px;
            font-size: 1.8rem;
            letter-spacing: 2px;
            text-align: center;
        }
        .install-content h3 {
            color: #00ff00;
            margin: 20px 0 10px;
            font-size: 1.3rem;
            letter-spacing: 1px;
        }
        .install-content p, .install-content li {
            color: #fff;
            line-height: 1.6;
            font-family: Arial, sans-serif;
            font-size: 0.95rem;
            margin: 10px 0;
        }
        .install-content ol {
            padding-left: 25px;
        }
        .install-content code {
            background: #000;
            color: #00ff00;
            padding: 2px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        .install-content .browser-section {
            background: #0a0a0a;
            border: 2px solid #333;
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
        }
        .install-content .close-btn {
            display: block;
            margin: 20px auto 0;
            background: #00ff00;
            color: #000;
            border: 2px solid #ffd700;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .install-content .close-btn:hover {
            background: #ffd700;
        }
    </style>
</head>
<body>
    <!-- Update Notification Modal -->
    <div id="updateModal" class="update-modal">
        <div class="update-content">
            <h2>🔄 <span data-translate-key="updateAvailable">Aggiornamento Disponibile!</span></h2>
            <p data-translate-key="updateMessage">È disponibile una nuova versione dell'app con miglioramenti e nuove funzionalità.</p>
            <p data-translate-key="updateInstructions">Per vedere gli aggiornamenti, ricarica la pagina premendo:</p>
            <div class="shortcut" id="updateShortcut">
                Ctrl + Shift + R
            </div>
            <div class="browser-info" data-translate-key="updateNote">
                Questo aggiorna la cache dell'app e scarica l'ultima versione
            </div>
            <button onclick="forceReload()" data-translate-key="updateNow">Aggiorna Ora</button>
            <button class="secondary" onclick="closeUpdateModal()" data-translate-key="updateLater">Più Tardi</button>
        </div>
    </div>

    <!-- Install Instructions Modal -->
    <div id="installModal" class="install-modal">
        <div class="install-content">
            <h2>📱 <span data-translate-key="installTitle">Installa l'App</span></h2>
            
            <div class="browser-section">
                <h3>🌐 Chrome / Edge (Desktop)</h3>
                <ol>
                    <li data-translate-key="installChrome1">Clicca sull'icona <strong>Install</strong> nella barra degli indirizzi (⊕)</li>
                    <li data-translate-key="installChrome2">Oppure: Menu (⋮) → <code>Installa Tabata Timer</code></li>
                    <li data-translate-key="installChrome3">L'app apparirà come programma standalone</li>
                </ol>
            </div>

            <div class="browser-section">
                <h3>🦊 Firefox (Desktop)</h3>
                <ol>
                    <li data-translate-key="installFirefox1">Clicca sui tre puntini <strong>(...)</strong> nella barra degli indirizzi</li>
                    <li data-translate-key="installFirefox2">Seleziona <code>Installa</code></li>
                    <li data-translate-key="installFirefox3">Oppure: Menu → <code>Installa il sito come app</code></li>
                </ol>
            </div>

            <div class="browser-section">
                <h3>📱 Chrome / Samsung Internet (Android)</h3>
                <ol>
                    <li data-translate-key="installAndroid1">Menu (⋮) → <code>Installa app</code></li>
                    <li data-translate-key="installAndroid2">Oppure: <code>Aggiungi a schermata Home</code></li>
                    <li data-translate-key="installAndroid3">L'icona apparirà tra le tue app</li>
                </ol>
            </div>

            <div class="browser-section">
                <h3>🍎 Safari (iPhone / iPad)</h3>
                <ol>
                    <li data-translate-key="installIOS1">Tocca il pulsante <strong>Condividi</strong> (quadrato con freccia)</li>
                    <li data-translate-key="installIOS2">Scorri e tocca <code>Aggiungi a schermata Home</code></li>
                    <li data-translate-key="installIOS3">Tocca <strong>Aggiungi</strong> in alto a destra</li>
                    <li data-translate-key="installIOS4">L'app apparirà nella home screen</li>
                </ol>
            </div>

            <div class="browser-section">
                <h3>🖥️ Safari (macOS)</h3>
                <ol>
                    <li data-translate-key="installMacOS1">File → <code>Aggiungi al Dock</code></li>
                    <li data-translate-key="installMacOS2">L'app apparirà nel Dock di macOS</li>
                </ol>
            </div>

            <button class="close-btn" onclick="closeInstallModal()" data-translate-key="installClose">Ho Capito</button>
        </div>
    </div>

    <button class="fullscreen-btn" id="fullscreenBtn">⛶ Fullscreen</button>
    <div class="shortcuts-hint" id="shortcutsHint">
        ⌨️ Space=Start/Pause • R=Reset • M=Mute • F=Fullscreen • ?=Help
    </div>
    <div class="container">
        <h1 data-translate-key="title">⏱️ CRONOMETRO TABATA</h1>
        <!-- Pannelli collassabili -->

        <div class="controls">
            <div class="control-group">
                <label data-translate-key="workLabel">⏳ Lavoro (sec):</label>
                <input type="number" id="workTime" value="20" min="1">
            </div>
            <div class="control-group">
                <label data-translate-key="restLabel">🛌 Recupero (sec):</label>
                <input type="number" id="restTime" value="10" min="1">
            </div>
            <div class="control-group">
                <label data-translate-key="roundsLabel">🔁 Round totali:</label>
                <input type="number" id="totalRounds" value="8" min="1">
            </div>
        </div>
        <details class="panel" open>
            <summary data-translate-key="presetTitle">Preset Rapidi</summary>
            <div class="group-body">
                <button type="button" class="preset-btn" data-preset="1">Tabata 20-10</button>
                <button type="button" class="preset-btn" data-preset="2">Tabata 30-15</button>
                <button type="button" class="preset-btn" data-preset="3">Tabata 40-20</button>
            </div>
        </details>
        <details class="panel">
            <summary data-translate-key="customPresetTitle">Preset Personalizzato</summary>
            <div class="group-body">
                <button type="button" id="savePresetBtn" data-translate-key="savePreset">💾 Salva</button>
                <button type="button" id="loadPresetBtn" data-translate-key="loadPreset">📂 Carica</button>
            </div>
        </details>
        <details class="panel">
            <summary data-translate-key="transferTitle">Importa / Esporta</summary>
            <div class="group-body">
                <button type="button" id="exportPresetBtn" data-translate-key="exportPreset">⬇️ Esporta</button>
                <label for="importPresetInput" style="display:none"></label>
                <input type="file" id="importPresetInput" accept="application/json" style="display:none">
                <button type="button" id="importPresetBtn" data-translate-key="importPreset">⬆️ Importa</button>
            </div>
        </details>
        
        <!-- Install PWA Button -->
        <button type="button" id="installBtn" class="install-btn" data-translate-key="installApp">📲 Installa App</button>
        <button type="button" id="installHelpBtn" class="install-btn" style="background:#333; display:block; margin-top:10px;" data-translate-key="installHelp">❓ Come Installare</button>
        
        <details class="panel">
            <summary data-translate-key="resourcesGroupTitle">Programma & Diario</summary>
            <div class="chip-links">
                <a class="link-chip highlight" data-translate-key="linkProgram" href="programma.html" target="_blank" rel="noopener noreferrer">⭐ PROGRAMMA COMPLETO</a>
                <a class="link-chip" data-translate-key="linkProgramText" href="programma_testo.html" target="_blank" rel="noopener noreferrer">🧾 Testo</a>
                <a class="link-chip" data-translate-key="linkDiary" href="diario.html" target="_blank" rel="noopener noreferrer">📝 Diario</a>
                <a class="link-chip" data-translate-key="linkAbout" href="about.html" target="_blank" rel="noopener noreferrer">ℹ️ About</a>
            </div>
        </details>
        <details class="panel">
            <summary>⚙️ Impostazioni</summary>
            <div class="group-body" style="display:block;">
                <div class="volume-control">
                    <label>🔊 Volume: <span id="volumeValue">80</span>%</label>
                    <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="80">
                </div>
                <div class="settings-row">
                    <span>🔔 Suoni Beep</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="toggleBeep" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="settings-row">
                    <span>🗣️ Voce Countdown</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="toggleVoice" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="settings-row">
                    <span>📳 Vibrazione</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="toggleVibration" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="settings-row">
                    <span>💡 Schermo Sempre Acceso</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="toggleWakeLock" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
        </details>
        <details class="panel">
            <summary data-translate-key="musicTitle">Playlist Musica</summary>
            <div class="music-links">
                <a href="https://open.spotify.com/search/workout%20playlist" target="_blank" rel="noopener noreferrer">Spotify</a>
                <a href="https://music.apple.com/search?term=workout" target="_blank" rel="noopener noreferrer">Apple Music</a>
                <a href="https://www.youtube.com/results?search_query=workout+music+playlist" target="_blank" rel="noopener noreferrer">YouTube</a>
                <a href="https://tidal.com/browse/search?q=workout" target="_blank" rel="noopener noreferrer">Tidal</a>
                <a href="https://soundcloud.com/search?q=workout%20mix" target="_blank" rel="noopener noreferrer">SoundCloud</a>
            </div>
        </details>

        <div id="round" data-translate-key="roundInitial">Round: 1/8</div>
        <div id="status" data-translate-key="statusInitial">PREMERE AVVIA</div>
        <div id="timer">--</div>

        <button id="startBtn" data-translate-key="startBtn">▶️ AVVIA TIMER</button>
        <button id="stopBtn" data-translate-key="stopBtn">⏹️ STOP</button>

        <!-- Fine pannelli -->
    </div>

    <script>
        const translations = {
            en: {
                title: "⏱️ TABATA TIMER",
                workLabel: "⏳ Work (sec):",
                restLabel: "🛌 Rest (sec):",
                roundsLabel: "🔁 Total Rounds:",
                savePreset: "💾 Save",
                loadPreset: "📂 Load",
                exportPreset: "⬇️ Export",
                importPreset: "⬆️ Import",
                startBtn: "▶️ START TIMER",
                stopBtn: "⏹️ STOP",
                statusInitial: "PRESS START",
                roundInitial: "Round: 1/8",
                statusWork: "🔥 WORK",
                statusRest: "💤 REST",
                statusStopped: "⏹️ STOPPED",
                sessionComplete: "🎉 SESSION COMPLETE!",
                greatWork: "Great job!",
                presetSaved: "Preset saved!",
                presetLoaded: "Preset loaded!",
                noPresetSaved: "No saved preset found.",
                presetExported: "No custom preset to export.",
                presetImported: "Preset imported and loaded!",
                invalidPresetFile: "Invalid preset file.",
                importError: "Error importing preset."
            },
            it: {
                title: "⏱️ CRONOMETRO TABATA",
                workLabel: "⏳ Lavoro (sec):",
                restLabel: "🛌 Recupero (sec):",
                roundsLabel: "🔁 Round totali:",
                savePreset: "💾 Salva",
                loadPreset: "📂 Carica",
                exportPreset: "⬇️ Esporta",
                importPreset: "⬆️ Importa",
                startBtn: "▶️ AVVIA TIMER",
                stopBtn: "⏹️ STOP",
                statusInitial: "PREMERE AVVIA",
                roundInitial: "Round: 1/8",
                statusWork: "🔥 LAVORO",
                statusRest: "💤 RECUPERO",
                statusStopped: "⏹️ FERMATO",
                sessionComplete: "🎉 SESSIONE COMPLETATA!",
                greatWork: "Ottimo lavoro!",
                presetSaved: "Preset salvato!",
                presetLoaded: "Preset caricato!",
                noPresetSaved: "Nessun preset salvato.",
                presetExported: "Nessun preset personalizzato da esportare.",
                presetImported: "Preset importato e caricato!",
                invalidPresetFile: "File preset non valido.",
                importError: "Errore durante l'importazione del preset."
            }
        };

        // Nuove chiavi pannelli / accordion
        translations.en.presetTitle = "Quick Presets";
        translations.it.presetTitle = "Preset Rapidi";
        translations.en.customPresetTitle = "Custom Preset";
        translations.it.customPresetTitle = "Preset Personalizzato";
        translations.en.transferTitle = "Import / Export";
        translations.it.transferTitle = "Importa / Esporta";
        translations.en.resourcesGroupTitle = "Program & Diary";
        translations.it.resourcesGroupTitle = "Programma & Diario";
        translations.en.musicTitle = "Music Playlists";
        translations.it.musicTitle = "Playlist Musica";

        // Aggiunta traduzioni link extra
        translations.en.linkProgram = "⭐ COMPLETE PROGRAM";
        translations.en.linkProgramText = "🧾 Plain Text";
        translations.en.linkDiary = "📝 Diary";
        translations.en.linkAbout = "ℹ️ About";
        translations.en.installApp = "📲 Install App";
        translations.it.linkProgram = "⭐ PROGRAMMA COMPLETO";
        translations.it.linkProgramText = "🧾 Testo";
        translations.it.linkDiary = "📝 Diario";
    translations.it.linkAbout = "ℹ️ About";
    translations.it.installApp = "📲 Installa App";
    translations.it.resourcesTitle = "Risorse";
    translations.en.resourcesTitle = "Resources";

    // Update Notification Translations
    translations.en.updateAvailable = "Update Available!";
    translations.it.updateAvailable = "Aggiornamento Disponibile!";
    translations.en.updateMessage = "A new version of the app is available with improvements and new features.";
    translations.it.updateMessage = "È disponibile una nuova versione dell'app con miglioramenti e nuove funzionalità.";
    translations.en.updateInstructions = "To see the updates, reload the page by pressing:";
    translations.it.updateInstructions = "Per vedere gli aggiornamenti, ricarica la pagina premendo:";
    translations.en.updateNote = "This updates the app cache and downloads the latest version";
    translations.it.updateNote = "Questo aggiorna la cache dell'app e scarica l'ultima versione";
    translations.en.updateNow = "Update Now";
    translations.it.updateNow = "Aggiorna Ora";
    translations.en.updateLater = "Later";
    translations.it.updateLater = "Più Tardi";

    // Install Instructions Translations
    translations.en.installHelp = "❓ How to Install";
    translations.it.installHelp = "❓ Come Installare";
    translations.en.installTitle = "Install the App";
    translations.it.installTitle = "Installa l'App";
    translations.en.installChrome1 = "Click the <strong>Install</strong> icon in the address bar (⊕)";
    translations.it.installChrome1 = "Clicca sull'icona <strong>Install</strong> nella barra degli indirizzi (⊕)";
    translations.en.installChrome2 = "Or: Menu (⋮) → <code>Install Tabata Timer</code>";
    translations.it.installChrome2 = "Oppure: Menu (⋮) → <code>Installa Tabata Timer</code>";
    translations.en.installChrome3 = "The app will appear as a standalone program";
    translations.it.installChrome3 = "L'app apparirà come programma standalone";
    translations.en.installFirefox1 = "Click the three dots <strong>(...)</strong> in the address bar";
    translations.it.installFirefox1 = "Clicca sui tre puntini <strong>(...)</strong> nella barra degli indirizzi";
    translations.en.installFirefox2 = "Select <code>Install</code>";
    translations.it.installFirefox2 = "Seleziona <code>Installa</code>";
    translations.en.installFirefox3 = "Or: Menu → <code>Install site as app</code>";
    translations.it.installFirefox3 = "Oppure: Menu → <code>Installa il sito come app</code>";
    translations.en.installAndroid1 = "Menu (⋮) → <code>Install app</code>";
    translations.it.installAndroid1 = "Menu (⋮) → <code>Installa app</code>";
    translations.en.installAndroid2 = "Or: <code>Add to Home screen</code>";
    translations.it.installAndroid2 = "Oppure: <code>Aggiungi a schermata Home</code>";
    translations.en.installAndroid3 = "The icon will appear among your apps";
    translations.it.installAndroid3 = "L'icona apparirà tra le tue app";
    translations.en.installIOS1 = "Tap the <strong>Share</strong> button (square with arrow)";
    translations.it.installIOS1 = "Tocca il pulsante <strong>Condividi</strong> (quadrato con freccia)";
    translations.en.installIOS2 = "Scroll and tap <code>Add to Home Screen</code>";
    translations.it.installIOS2 = "Scorri e tocca <code>Aggiungi a schermata Home</code>";
    translations.en.installIOS3 = "Tap <strong>Add</strong> in the top right";
    translations.it.installIOS3 = "Tocca <strong>Aggiungi</strong> in alto a destra";
    translations.en.installIOS4 = "The app will appear on your home screen";
    translations.it.installIOS4 = "L'app apparirà nella home screen";
    translations.en.installMacOS1 = "File → <code>Add to Dock</code>";
    translations.it.installMacOS1 = "File → <code>Aggiungi al Dock</code>";
    translations.en.installMacOS2 = "The app will appear in the macOS Dock";
    translations.it.installMacOS2 = "L'app apparirà nel Dock di macOS";
    translations.en.installClose = "Got It";
    translations.it.installClose = "Ho Capito";

        const userLang = navigator.language.startsWith('en') ? 'en' : 'it';
        let currentStrings = translations[userLang];

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('[data-translate-key]').forEach(el => {
                const key = el.getAttribute('data-translate-key');
                if (currentStrings[key]) {
                    el.innerHTML = currentStrings[key];
                }
            });
            document.documentElement.lang = userLang;
        });

        let workTime = 20;
        let restTime = 10;
// ... existing code ...
        let totalRounds = 8;
        let currentRound = 1;
        let isWorkPhase = true;
        let timer;
        let countdown;
        let speechSynth = window.speechSynthesis;

        // Settings
        let volumeLevel = 0.8;
        let beepEnabled = true;
        let voiceEnabled = true;
        let vibrationEnabled = true;
        let wakeLockEnabled = true;
        let wakeLock = null;

        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const timerDisplay = document.getElementById('timer');
        const roundDisplay = document.getElementById('round');
        const statusDisplay = document.getElementById('status');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeValue = document.getElementById('volumeValue');
        const toggleBeep = document.getElementById('toggleBeep');
        const toggleVoice = document.getElementById('toggleVoice');
        const toggleVibration = document.getElementById('toggleVibration');
        const toggleWakeLock = document.getElementById('toggleWakeLock');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const shortcutsHint = document.getElementById('shortcutsHint');
    const presetBtns = document.querySelectorAll('.preset-btn');
    const savePresetBtn = document.getElementById('savePresetBtn');
    const loadPresetBtn = document.getElementById('loadPresetBtn');
    const exportPresetBtn = document.getElementById('exportPresetBtn');
    const importPresetBtn = document.getElementById('importPresetBtn');
    const importPresetInput = document.getElementById('importPresetInput');
    
        // Volume Control
        volumeSlider.addEventListener('input', (e) => {
            volumeLevel = e.target.value / 100;
            volumeValue.textContent = e.target.value;
            localStorage.setItem('tabataVolume', e.target.value);
        });
        
        // Settings Toggles
        toggleBeep.addEventListener('change', (e) => {
            beepEnabled = e.target.checked;
            localStorage.setItem('tabataBeepEnabled', e.target.checked);
        });
        
        toggleVoice.addEventListener('change', (e) => {
            voiceEnabled = e.target.checked;
            localStorage.setItem('tabataVoiceEnabled', e.target.checked);
        });
        
        toggleVibration.addEventListener('change', (e) => {
            vibrationEnabled = e.target.checked;
            localStorage.setItem('tabataVibrationEnabled', e.target.checked);
        });
        
        toggleWakeLock.addEventListener('change', (e) => {
            wakeLockEnabled = e.target.checked;
            localStorage.setItem('tabataWakeLockEnabled', e.target.checked);
            if (!e.target.checked && wakeLock) {
                releaseWakeLock();
            }
        });
        
        // Load saved settings
        function loadSettings() {
            const savedVolume = localStorage.getItem('tabataVolume');
            if (savedVolume) {
                volumeLevel = savedVolume / 100;
                volumeSlider.value = savedVolume;
                volumeValue.textContent = savedVolume;
            }
            
            const savedBeep = localStorage.getItem('tabataBeepEnabled');
            if (savedBeep !== null) {
                beepEnabled = savedBeep === 'true';
                toggleBeep.checked = beepEnabled;
            }
            
            const savedVoice = localStorage.getItem('tabataVoiceEnabled');
            if (savedVoice !== null) {
                voiceEnabled = savedVoice === 'true';
                toggleVoice.checked = voiceEnabled;
            }
            
            const savedVibration = localStorage.getItem('tabataVibrationEnabled');
            if (savedVibration !== null) {
                vibrationEnabled = savedVibration === 'true';
                toggleVibration.checked = vibrationEnabled;
            }
            
            const savedWakeLock = localStorage.getItem('tabataWakeLockEnabled');
            if (savedWakeLock !== null) {
                wakeLockEnabled = savedWakeLock === 'true';
                toggleWakeLock.checked = wakeLockEnabled;
            }
        }
        
        loadSettings();
        
        // Wake Lock
        async function requestWakeLock() {
            if (!wakeLockEnabled) return;
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake Lock attivo');
                    wakeLock.addEventListener('release', () => {
                        console.log('Wake Lock rilasciato');
                    });
                }
            } catch (err) {
                console.log('Wake Lock non supportato:', err);
            }
        }
        
        function releaseWakeLock() {
            if (wakeLock) {
                wakeLock.release();
                wakeLock = null;
            }
        }
        
        // Fullscreen
        fullscreenBtn.addEventListener('click', toggleFullscreen);
        
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log('Fullscreen non supportato:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }
        
        // Keyboard Shortcuts
        let shortcutsVisible = false;
        document.addEventListener('keydown', (e) => {
            // Ignora se si sta scrivendo in un input
            if (e.target.tagName === 'INPUT') return;
            
            switch(e.key.toLowerCase()) {
                case ' ':
                    e.preventDefault();
                    if (!timer) {
                        startTimer();
                    } else {
                        stopTimer();
                    }
                    break;
                case 'r':
                    e.preventDefault();
                    stopTimer();
                    break;
                case 'm':
                    e.preventDefault();
                    toggleBeep.checked = !toggleBeep.checked;
                    beepEnabled = toggleBeep.checked;
                    toggleVoice.checked = !toggleVoice.checked;
                    voiceEnabled = toggleVoice.checked;
                    break;
                case 'f':
                    e.preventDefault();
                    toggleFullscreen();
                    break;
                case '?':
                    e.preventDefault();
                    shortcutsVisible = !shortcutsVisible;
                    shortcutsHint.classList.toggle('visible', shortcutsVisible);
                    setTimeout(() => {
                        shortcutsHint.classList.remove('visible');
                        shortcutsVisible = false;
                    }, 5000);
                    break;
            }
        });
        
        // Vibration function
        function vibrate(pattern = [200]) {
            if (vibrationEnabled && 'vibrate' in navigator) {
                navigator.vibrate(pattern);
            }
        }
        // Esporta preset personalizzato in file JSON
        exportPresetBtn.addEventListener('click', () => {
            const preset = localStorage.getItem('tabataCustomPreset');
            if (!preset) {
                alert(currentStrings.presetExported);
                return;
            }
            const blob = new Blob([preset], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'tabata-preset.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // Importa preset personalizzato da file JSON
        importPresetBtn.addEventListener('click', () => {
            importPresetInput.click();
        });

        importPresetInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const preset = JSON.parse(e.target.result);
                    if (
                        typeof preset.work === 'number' &&
                        typeof preset.rest === 'number' &&
                        typeof preset.rounds === 'number'
                    ) {
                        localStorage.setItem('tabataCustomPreset', JSON.stringify(preset));
                        document.getElementById('workTime').value = preset.work;
                        document.getElementById('restTime').value = preset.rest;
                        document.getElementById('totalRounds').value = preset.rounds;
                        alert(currentStrings.presetImported);
                    } else {
                        alert(currentStrings.invalidPresetFile);
                    }
                } catch (err) {
                    alert(currentStrings.importError);
                }
            };
            reader.readAsText(file);
        });

        // Preset predefiniti
        const tabataPresets = {
            1: { work: 20, rest: 10, rounds: 8 },
            2: { work: 30, rest: 15, rounds: 6 },
            3: { work: 40, rest: 20, rounds: 4 }
        };

        // Carica preset rapido
        presetBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const p = tabataPresets[btn.dataset.preset];
                if (p) {
                    document.getElementById('workTime').value = p.work;
                    document.getElementById('restTime').value = p.rest;
                    document.getElementById('totalRounds').value = p.rounds;
                }
            });
        });

        // Salva preset personalizzato su localStorage
        savePresetBtn.addEventListener('click', () => {
            const preset = {
                work: parseInt(document.getElementById('workTime').value) || 20,
                rest: parseInt(document.getElementById('restTime').value) || 10,
                rounds: parseInt(document.getElementById('totalRounds').value) || 8
            };
            localStorage.setItem('tabataCustomPreset', JSON.stringify(preset));
            alert(currentStrings.presetSaved);
        });

        // Carica preset personalizzato da localStorage
        loadPresetBtn.addEventListener('click', () => {
            const preset = JSON.parse(localStorage.getItem('tabataCustomPreset'));
            if (preset) {
                document.getElementById('workTime').value = preset.work;
                document.getElementById('restTime').value = preset.rest;
                document.getElementById('totalRounds').value = preset.rounds;
                alert(currentStrings.presetLoaded);
            } else {
                alert(currentStrings.noPresetSaved);
            }
        });

        startBtn.addEventListener('click', startTimer);
        stopBtn.addEventListener('click', stopTimer);

        // Aggiorna i valori quando si clicca su AVVIA
        function startTimer() {
            workTime = parseInt(document.getElementById('workTime').value) || 20;
            restTime = parseInt(document.getElementById('restTime').value) || 10;
            totalRounds = parseInt(document.getElementById('totalRounds').value) || 8;

            stopTimer();
            currentRound = 1;
            isWorkPhase = true;
            countdown = workTime;
            updateDisplay();
            timer = setInterval(tick, 1000);
            
            // Attiva Wake Lock
            requestWakeLock();
            
            // Salva workout iniziato
            saveWorkoutStart();
        }

        function tick() {
            countdown--;
            speakLastThreeSeconds(countdown);
            
            // Flash visuale ultimi 3 secondi
            if (countdown <= 3 && countdown > 0) {
                timerDisplay.classList.add('flash-warning');
            } else {
                timerDisplay.classList.remove('flash-warning');
            }
            
            updateDisplay();

            if (countdown <= 0) {
                playBeep(isWorkPhase ? 1500 : 800);
                vibrate(isWorkPhase ? [200, 100, 200] : [400]);

                if (isWorkPhase) {
                    // Passa a recupero
                    isWorkPhase = false;
                    countdown = restTime;
                } else {
                    // Passa a lavoro
                    currentRound++;
                    if (currentRound > totalRounds) {
                        endSession();
                        return;
                    }
                    isWorkPhase = true;
                    countdown = workTime;
                }
                updateDisplay();
            }
        }

        function updateDisplay() {
            timerDisplay.textContent = countdown;
            timerDisplay.className = isWorkPhase ? 'work' : 'rest';
            statusDisplay.textContent = isWorkPhase ? currentStrings.statusWork : currentStrings.statusRest;
            roundDisplay.textContent = `Round: ${currentRound}/${totalRounds}`;
        }

        function speakLastThreeSeconds(seconds) {
            if (seconds <= 3 && seconds > 0 && speechSynth && voiceEnabled) {
                // Annulla eventuali pronunce precedenti
                speechSynth.cancel();
                // Crea e pronuncia
                const utterance = new SpeechSynthesisUtterance(seconds.toString());
                utterance.rate = 1.2;
                utterance.pitch = 1.5;
                utterance.volume = volumeLevel;
                speechSynth.speak(utterance);
            }
        }

        function playBeep(frequency, duration = 300) {
            if (!beepEnabled) return;
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                oscillator.frequency.value = frequency;
                oscillator.type = "sine";
                gainNode.gain.setValueAtTime(0.1 * volumeLevel, audioCtx.currentTime);
                oscillator.start();
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration/1000);
                oscillator.stop(audioCtx.currentTime + duration/1000);
            } catch(e) {
                console.log("Beep non supportato");
            }
        }

        function endSession() {
            clearInterval(timer);
            timer = null;
            timerDisplay.textContent = "✅";
            timerDisplay.className = "";
            timerDisplay.classList.remove('flash-warning');
            statusDisplay.textContent = currentStrings.sessionComplete;
            playBeep(2000, 1000);
            vibrate([300, 100, 300, 100, 300]);

            if (speechSynth && voiceEnabled) {
                speechSynth.cancel();
                const utterance = new SpeechSynthesisUtterance(`${currentStrings.sessionComplete} ${currentStrings.greatWork}`);
                utterance.lang = userLang;
                utterance.rate = 1.1;
                utterance.pitch = 1.2;
                utterance.volume = volumeLevel;
                speechSynth.speak(utterance);
            }
            
            // Rilascia Wake Lock
            releaseWakeLock();
            
            // Salva workout completato
            saveWorkoutComplete();
        }

        function stopTimer() {
            clearInterval(timer);
            timer = null;
            timerDisplay.textContent = "--";
            timerDisplay.classList.remove('flash-warning');
            statusDisplay.textContent = currentStrings.statusStopped;
            if (speechSynth) speechSynth.cancel();
            
            // Rilascia Wake Lock
            releaseWakeLock();
        }
        
        // Workout History Functions
        function saveWorkoutStart() {
            const workoutData = {
                date: new Date().toISOString(),
                work: workTime,
                rest: restTime,
                rounds: totalRounds,
                started: true,
                completed: false
            };
            localStorage.setItem('tabataCurrentWorkout', JSON.stringify(workoutData));
        }
        
        function saveWorkoutComplete() {
            const current = JSON.parse(localStorage.getItem('tabataCurrentWorkout') || '{}');
            if (!current.started) return;
            
            current.completed = true;
            current.completedAt = new Date().toISOString();
            
            // Aggiungi allo storico
            const history = JSON.parse(localStorage.getItem('tabataHistory') || '[]');
            history.push(current);
            localStorage.setItem('tabataHistory', JSON.stringify(history));
            localStorage.removeItem('tabataCurrentWorkout');
            
            // Aggiorna statistiche
            updateStats();
        }
        
        function updateStats() {
            const history = JSON.parse(localStorage.getItem('tabataHistory') || '[]');
            const stats = {
                totalWorkouts: history.length,
                totalRounds: history.reduce((sum, w) => sum + (w.rounds || 0), 0),
                lastWorkout: history[history.length - 1]?.completedAt || null
            };
            localStorage.setItem('tabataStats', JSON.stringify(stats));
        }
        
        // Register Service Worker for PWA with Update Detection
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('SW registrato:', registration.scope);
                        
                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            console.log('Nuovo SW trovato!');
                            
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New service worker available, show update notification
                                    console.log('Aggiornamento disponibile!');
                                    showUpdateNotification();
                                }
                            });
                        });
                        
                        // Check for updates every 60 seconds
                        setInterval(() => {
                            registration.update();
                        }, 60000);
                    })
                    .catch((err) => {
                        console.log('SW registrazione fallita:', err);
                    });
            });
        }
        
        // Update Notification Functions
        function showUpdateNotification() {
            const updateModal = document.getElementById('updateModal');
            const shortcutEl = document.getElementById('updateShortcut');
            
            // Detect OS for correct shortcut
            const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
            shortcutEl.textContent = isMac ? 'Cmd + Shift + R' : 'Ctrl + Shift + R';
            
            updateModal.classList.add('show');
        }
        
        function closeUpdateModal() {
            const updateModal = document.getElementById('updateModal');
            updateModal.classList.remove('show');
        }
        
        function forceReload() {
            // Clear cache and reload
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => caches.delete(name));
                });
            }
            window.location.reload(true);
        }
        
        // Install Instructions Modal Functions
        function showInstallModal() {
            const installModal = document.getElementById('installModal');
            installModal.classList.add('show');
        }
        
        function closeInstallModal() {
            const installModal = document.getElementById('installModal');
            installModal.classList.remove('show');
        }
        
        // Install Help Button
        const installHelpBtn = document.getElementById('installHelpBtn');
        installHelpBtn.addEventListener('click', showInstallModal);
        
        // Install PWA prompt
        let deferredPrompt;
        const installBtn = document.getElementById('installBtn');
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // Mostra il pulsante Install
            installBtn.style.display = 'block';
            console.log('App installabile!');
        });
        
        installBtn.addEventListener('click', async () => {
            if (!deferredPrompt) {
                // Se non c'è prompt nativo, mostra istruzioni
                showInstallModal();
                return;
            }
            
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`Utente ha scelto: ${outcome}`);
            
            if (outcome === 'accepted') {
                installBtn.style.display = 'none';
            }
            
            deferredPrompt = null;
        });
        
        // Nascondi il pulsante se l'app è già installata
        window.addEventListener('appinstalled', () => {
            installBtn.style.display = 'none';
            console.log('App installata con successo!');
        });
        
        // Detect if running as PWA
        function isPWA() {
            return window.matchMedia('(display-mode: standalone)').matches || 
                   window.navigator.standalone === true;
        }
        
        // Show install button always (for browsers that don't support beforeinstallprompt)
        if (!isPWA()) {
            installBtn.style.display = 'block';
        }
    </script>
</body>
</html>

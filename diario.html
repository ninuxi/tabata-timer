<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="theme-color" content="#00ff00">
<link rel="manifest" href="manifest.json">
<title>Diario Allenamenti Tabata</title>
<style>
:root { 
    --bg:#0b0b0b; --panel:#141414; --accent:#00ff00; --accent2:#ff6b35; 
    --accent3:#ffd700; --text:#f8f8f8; --border:#333;
    --font-heading:'Impact','Bebas Neue','Oswald',sans-serif;
}
* { box-sizing:border-box; margin:0; padding:0; }
body { font-family:Arial, sans-serif; background:var(--bg); color:var(--text); padding:20px 16px 90px; line-height:1.4; }

h1 { 
    font-family:var(--font-heading); letter-spacing:2px; font-size:2rem; 
    margin:10px 0 8px; color:var(--accent3); text-align:center; 
}
.subtitle { text-align:center; font-size:0.85rem; color:#aaa; margin:0 0 20px; }

.container { max-width:1200px; margin:0 auto; }

/* Stats Cards */
.stats-grid {
    display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); 
    gap:12px; margin:20px 0;
}
.stat-card {
    background:var(--panel); border:2px solid var(--accent); border-radius:12px;
    padding:16px; text-align:center;
}
.stat-card .label { font-size:0.75rem; color:#999; text-transform:uppercase; letter-spacing:1px; }
.stat-card .value { 
    font-size:2rem; font-family:var(--font-heading); color:var(--accent3); 
    margin:8px 0;
}
.stat-card .subtext { font-size:0.7rem; color:#666; }

/* Calendar */
.calendar-container {
    background:var(--panel); border:2px solid var(--border); border-radius:12px;
    padding:16px; margin:20px 0;
}
.calendar-header {
    display:flex; justify-content:space-between; align-items:center;
    margin-bottom:16px; padding-bottom:12px; border-bottom:1px solid var(--border);
}
.calendar-header h2 {
    font-family:var(--font-heading); font-size:1.3rem; color:var(--accent3);
}
.calendar-nav button {
    background:var(--accent); color:#000; border:none; padding:8px 16px;
    border-radius:20px; cursor:pointer; font-weight:700; margin:0 4px;
}
.calendar-nav button:hover { background:var(--accent3); }
.calendar-grid {
    display:grid; grid-template-columns:repeat(7,1fr); gap:4px;
}
.calendar-day {
    aspect-ratio:1; background:#111; border:1px solid var(--border);
    border-radius:8px; display:flex; flex-direction:column;
    align-items:center; justify-content:center; padding:4px;
    font-size:0.75rem; position:relative; cursor:pointer;
}
.calendar-day:hover { border-color:var(--accent); }
.calendar-day.header {
    background:var(--panel); font-weight:700; color:var(--accent3);
    cursor:default;
}
.calendar-day.other-month { opacity:0.3; }
.calendar-day.today { border:2px solid var(--accent3); background:#1a1a1a; }
.calendar-day.has-workout {
    background:linear-gradient(135deg, var(--accent) 0%, var(--accent2) 100%);
    color:#000; font-weight:700;
}
.calendar-day .workout-badge {
    position:absolute; top:2px; right:2px; width:8px; height:8px;
    background:var(--accent3); border-radius:50%;
}

/* Workout List */
.workout-list {
    background:var(--panel); border:2px solid var(--border); border-radius:12px;
    padding:16px; margin:20px 0;
}
.workout-list h2 {
    font-family:var(--font-heading); font-size:1.3rem; color:var(--accent3);
    margin-bottom:16px; padding-bottom:8px; border-bottom:1px solid var(--border);
}
.workout-item {
    background:#111; border:1px solid var(--border); border-radius:8px;
    padding:12px; margin:8px 0; display:flex; justify-content:space-between;
    align-items:center; transition:all 0.2s;
}
.workout-item:hover { border-color:var(--accent); transform:translateX(4px); }
.workout-info {
    flex:1;
}
.workout-date {
    font-size:0.7rem; color:var(--accent3); font-weight:700;
    text-transform:uppercase; letter-spacing:1px;
}
.workout-details {
    font-size:0.8rem; color:#ccc; margin:4px 0;
}
.workout-stats {
    display:flex; gap:12px; font-size:0.7rem; color:#888;
}
.workout-actions {
    display:flex; gap:8px;
}
.workout-actions button {
    background:transparent; border:1px solid var(--border);
    color:var(--text); padding:6px 12px; border-radius:16px;
    cursor:pointer; font-size:0.65rem; transition:all 0.2s;
}
.workout-actions button:hover { border-color:var(--accent); background:var(--accent); color:#000; }

/* Controls */
.controls {
    display:flex; flex-wrap:wrap; gap:10px; margin:20px 0;
    justify-content:center;
}
button, a.btn {
    background:var(--accent3); color:#000; font-weight:800;
    font-family:var(--font-heading); border:2px solid var(--accent);
    padding:10px 18px; border-radius:40px; cursor:pointer;
    font-size:0.75rem; letter-spacing:1px; text-decoration:none;
    transition:all 0.3s; display:inline-block;
}
button:hover, a.btn:hover { background:var(--accent); transform:translateY(-2px); }
button.secondary {
    background:#333; border-color:#555;
}
button.secondary:hover {
    background:#444;
}

/* Empty State */
.empty-state {
    text-align:center; padding:40px 20px; color:#666;
}
.empty-state .icon { font-size:4rem; margin-bottom:16px; }
.empty-state h3 { font-size:1.2rem; color:#888; margin-bottom:8px; }
.empty-state p { font-size:0.85rem; }

@media (max-width:768px){
    .stats-grid { grid-template-columns:repeat(2,1fr); }
    .calendar-day { font-size:0.65rem; }
    .workout-item { flex-direction:column; align-items:flex-start; gap:8px; }
    .workout-actions { width:100%; justify-content:flex-end; }
}
</style>
</head>
<body>
<!-- Language Selector -->
<div style="position:fixed;top:10px;right:10px;z-index:9999;display:flex;gap:6px;">
    <button id="langIT" style="background:#00ff00;color:#000;border:2px solid #00ff00;padding:6px 12px;border-radius:20px;cursor:pointer;font-weight:700;font-size:0.7rem;">üáÆüáπ IT</button>
    <button id="langEN" style="background:#333;color:#fff;border:2px solid #555;padding:6px 12px;border-radius:20px;cursor:pointer;font-weight:700;font-size:0.7rem;">üá¨üáß EN</button>
</div>

    <div class="container">
        <h1 data-i18n="title">üìÖ DIARIO ALLENAMENTI</h1>
        <p class="subtitle" data-i18n="subtitle">Tracciamento automatico ‚Ä¢ Calendario visuale ‚Ä¢ Esporta su Google Calendar</p>
        
        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="label" data-i18n="totalWorkouts">Totale Workout</div>
                <div class="value" id="totalWorkouts">0</div>
                <div class="subtext" data-i18n="completedSessions">sessioni completate</div>
            </div>
            <div class="stat-card">
                <div class="label" data-i18n="thisWeek">Questa Settimana</div>
                <div class="value" id="weekWorkouts">0</div>
                <div class="subtext" data-i18n="weekGoal">su 4 obiettivo</div>
            </div>
            <div class="stat-card">
                <div class="label" data-i18n="streak">Streak</div>
                <div class="value" id="streakDays">0</div>
                <div class="subtext" data-i18n="consecutiveDays">giorni consecutivi</div>
            </div>
            <div class="stat-card">
                <div class="label" data-i18n="totalRounds">Round Totali</div>
                <div class="value" id="totalRounds">0</div>
                <div class="subtext" data-i18n="completedRounds">round completati</div>
            </div>
        </div>

        <!-- Calendar -->
        <div class="calendar-container">
            <div class="calendar-header">
                <h2 id="calendarMonth">Ottobre 2025</h2>
                <div class="calendar-nav">
                    <button id="prevMonth">‚óÄ</button>
                    <button id="todayBtn" data-i18n="today">Oggi</button>
                    <button id="nextMonth">‚ñ∂</button>
                </div>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <button id="exportGoogleBtn" data-i18n="exportGoogle">üìÖ Google Calendar</button>
            <button id="exportIcalBtn" data-i18n="exportIcal">üìÜ iCal/Outlook</button>
            <button id="exportJsonBtn" data-i18n="exportJson">‚¨áÔ∏è JSON</button>
            <button class="secondary" id="clearDataBtn" data-i18n="clearData">üóëÔ∏è Cancella</button>
        </div>

        <!-- Workout List -->
        <div class="workout-list">
            <h2 data-i18n="recentWorkouts">üìù Ultimi Allenamenti</h2>
            <div id="workoutListContainer"></div>
        </div>

        <!-- Bottom Navigation -->
        <div class="controls" style="margin-top:40px;">
            <a class="btn" href="index.html" data-i18n="timer">‚è±Ô∏è Timer</a>
            <a class="btn" href="programma.html" data-i18n="program">üìÑ Programma</a>
        </div>
    </div>

<script>
const HISTORY_KEY = 'tabataHistory';
let currentDate = new Date();
let workoutHistory = [];

function loadData() {
    const historyRaw = localStorage.getItem(HISTORY_KEY);
    if (historyRaw) workoutHistory = JSON.parse(historyRaw);
    updateStats();
    renderCalendar();
    renderWorkoutList();
}

function updateStats() {
    const stats = calculateStats();
    document.getElementById('totalWorkouts').textContent = stats.total;
    document.getElementById('weekWorkouts').textContent = stats.thisWeek;
    document.getElementById('streakDays').textContent = stats.streak;
    document.getElementById('totalRounds').textContent = stats.totalRounds;
}

function calculateStats() {
    const now = new Date();
    const startOfWeek = new Date(now);
    startOfWeek.setDate(now.getDate() - now.getDay());
    startOfWeek.setHours(0,0,0,0);
    
    const thisWeek = workoutHistory.filter(w => {
        const wDate = new Date(w.completedAt || w.date);
        return wDate >= startOfWeek && w.completed;
    }).length;
    
    const totalRounds = workoutHistory.reduce((sum, w) => sum + (w.rounds || 0), 0);
    
    // Calculate streak
    let streak = 0;
    const sortedWorkouts = [...workoutHistory]
        .filter(w => w.completed)
        .sort((a, b) => new Date(b.completedAt) - new Date(a.completedAt));
    
    if (sortedWorkouts.length > 0) {
        const uniqueDays = new Set();
        sortedWorkouts.forEach(w => {
            const date = new Date(w.completedAt);
            uniqueDays.add(date.toDateString());
        });
        
        const sortedDays = Array.from(uniqueDays).sort((a, b) => new Date(b) - new Date(a));
        let checkDate = new Date();
        checkDate.setHours(0,0,0,0);
        
        for (const dayStr of sortedDays) {
            const day = new Date(dayStr);
            if (day.toDateString() === checkDate.toDateString()) {
                streak++;
                checkDate.setDate(checkDate.getDate() - 1);
            } else break;
        }
    }
    
    return {
        total: workoutHistory.filter(w => w.completed).length,
        thisWeek,
        streak,
        totalRounds
    };
}

function renderCalendar() {
    const grid = document.getElementById('calendarGrid');
    grid.innerHTML = '';
    
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    
    const monthNames = translations[currentLang].monthNames;
    document.getElementById('calendarMonth').textContent = `${monthNames[month]} ${year}`;
    
    const days = translations[currentLang].dayNames;
    days.forEach(day => {
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day header';
        dayEl.textContent = day;
        grid.appendChild(dayEl);
    });
    
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDay = firstDay.getDay();
    
    const prevMonthDays = new Date(year, month, 0).getDate();
    for (let i = startDay - 1; i >= 0; i--) {
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day other-month';
        dayEl.textContent = prevMonthDays - i;
        grid.appendChild(dayEl);
    }
    
    const today = new Date();
    for (let day = 1; day <= lastDay.getDate(); day++) {
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day';
        dayEl.textContent = day;
        
        const dayDate = new Date(year, month, day);
        
        if (dayDate.toDateString() === today.toDateString()) {
            dayEl.classList.add('today');
        }
        
        const hasWorkout = workoutHistory.some(w => {
            const wDate = new Date(w.completedAt || w.date);
            return wDate.toDateString() === dayDate.toDateString() && w.completed;
        });
        
        if (hasWorkout) {
            dayEl.classList.add('has-workout');
            const badge = document.createElement('div');
            badge.className = 'workout-badge';
            dayEl.appendChild(badge);
        }
        
        dayEl.addEventListener('click', () => showDayWorkouts(dayDate));
        grid.appendChild(dayEl);
    }
    
    const remainingDays = 42 - (startDay + lastDay.getDate());
    for (let i = 1; i <= remainingDays; i++) {
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day other-month';
        dayEl.textContent = i;
        grid.appendChild(dayEl);
    }
}

function showDayWorkouts(date) {
    const workouts = workoutHistory.filter(w => {
        const wDate = new Date(w.completedAt || w.date);
        return wDate.toDateString() === date.toDateString() && w.completed;
    });
    
    const locale = currentLang === 'it' ? 'it-IT' : 'en-US';
    if (workouts.length === 0) {
        alert(`${translations[currentLang].noWorkout} ${date.toLocaleDateString(locale)}`);
    } else {
        const details = workouts.map(w => 
            `‚è±Ô∏è ${w.work}"/${w.rest}" x ${w.rounds} round\\n` +
            `‚è∞ ${new Date(w.completedAt).toLocaleTimeString(locale)}`
        ).join('\\n\\n');
        alert(`${translations[currentLang].workoutsOn} ${date.toLocaleDateString(locale)}:\\n\\n${details}`);
    }
}

function renderWorkoutList() {
    const container = document.getElementById('workoutListContainer');
    
    const completedWorkouts = workoutHistory
        .filter(w => w.completed)
        .sort((a, b) => new Date(b.completedAt) - new Date(a.completedAt))
        .slice(0, 20);
    
    if (completedWorkouts.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="icon">üèãÔ∏è</div>
                <h3>${translations[currentLang].noWorkoutYet}</h3>
                <p>${translations[currentLang].completeFirst}</p>
            </div>
        `;
        return;
    }
    
    const locale = currentLang === 'it' ? 'it-IT' : 'en-US';
    container.innerHTML = completedWorkouts.map((workout, index) => {
        const date = new Date(workout.completedAt);
        const dateStr = date.toLocaleDateString(locale, { 
            weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' 
        });
        const timeStr = date.toLocaleTimeString(locale, { hour: '2-digit', minute: '2-digit' });
        
        return `
            <div class="workout-item">
                <div class="workout-info">
                    <div class="workout-date">${dateStr} ‚Ä¢ ${timeStr}</div>
                    <div class="workout-details">
                        ‚è±Ô∏è Tabata ${workout.work}"/${workout.rest}" ‚Ä¢ ${workout.rounds} round
                    </div>
                    <div class="workout-stats">
                        <span>üí™ #${completedWorkouts.length - index}</span>
                        <span>üî• ${(workout.work * workout.rounds / 60).toFixed(1)} min attivi</span>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

document.getElementById('prevMonth').addEventListener('click', () => {
    currentDate.setMonth(currentDate.getMonth() - 1);
    renderCalendar();
});

document.getElementById('nextMonth').addEventListener('click', () => {
    currentDate.setMonth(currentDate.getMonth() + 1);
    renderCalendar();
});

document.getElementById('todayBtn').addEventListener('click', () => {
    currentDate = new Date();
    renderCalendar();
});

function generateICS(workouts) {
    let ics = 'BEGIN:VCALENDAR\\nVERSION:2.0\\nPRODID:-//Tabata Timer//IT\\nCALSCALE:GREGORIAN\\n';
    workouts.forEach(w => {
        const date = new Date(w.completedAt);
        const dateStr = date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
        ics += `BEGIN:VEVENT\\nUID:${w.completedAt}@tabata\\nDTSTAMP:${dateStr}\\nDTSTART:${dateStr}\\n`;
        ics += `SUMMARY:Tabata ${w.work}/${w.rest} x${w.rounds}\\nEND:VEVENT\\n`;
    });
    ics += 'END:VCALENDAR';
    return ics;
}

document.getElementById('exportGoogleBtn').addEventListener('click', () => {
    const workouts = workoutHistory.filter(w => w.completed);
    if (workouts.length === 0) return alert(translations[currentLang].noWorkouts);
    const w = workouts[workouts.length - 1];
    const date = new Date(w.completedAt);
    const dateStr = date.toISOString().replace(/[-:.]/g, '').split('Z')[0];
    const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=Tabata ${w.work}/${w.rest}&dates=${dateStr}/${dateStr}&details=Tabata: ${w.rounds} round`;
    window.open(url, '_blank');
});

document.getElementById('exportIcalBtn').addEventListener('click', () => {
    const workouts = workoutHistory.filter(w => w.completed);
    if (workouts.length === 0) return alert(translations[currentLang].noWorkouts);
    const ics = generateICS(workouts);
    const blob = new Blob([ics], { type: 'text/calendar' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'tabata-workouts.ics';
    a.click();
    URL.revokeObjectURL(url);
});

document.getElementById('exportJsonBtn').addEventListener('click', () => {
    const json = JSON.stringify(workoutHistory, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'tabata-history.json';
    a.click();
    URL.revokeObjectURL(url);
});

document.getElementById('clearDataBtn').addEventListener('click', () => {
    if (!confirm(translations[currentLang].deleteAll)) return;
    localStorage.removeItem(HISTORY_KEY);
    workoutHistory = [];
    loadData();
});

loadData();
window.addEventListener('storage', (e) => {
    if (e.key === HISTORY_KEY) loadData();
});

// Multilingual System
const translations = {
    it: {
        title: 'üìÖ DIARIO ALLENAMENTI',
        subtitle: 'Tracciamento automatico ‚Ä¢ Calendario visuale ‚Ä¢ Esporta su Google Calendar',
        totalWorkouts: 'Totale Workout',
        completedSessions: 'sessioni completate',
        thisWeek: 'Questa Settimana',
        weekGoal: 'su 4 obiettivo',
        streak: 'Streak',
        consecutiveDays: 'giorni consecutivi',
        totalRounds: 'Round Totali',
        completedRounds: 'round completati',
        today: 'Oggi',
        exportGoogle: 'üìÖ Google Calendar',
        exportIcal: 'üìÜ iCal/Outlook',
        exportJson: '‚¨áÔ∏è JSON',
        clearData: 'üóëÔ∏è Cancella',
        recentWorkouts: 'üìù Ultimi Allenamenti',
        timer: '‚è±Ô∏è Timer',
        program: 'üìÑ Programma',
        noWorkout: 'Nessun allenamento il',
        workoutsOn: 'Allenamenti del',
        noWorkoutYet: 'Nessun allenamento ancora',
        completeFirst: 'Completa il tuo primo workout dal timer!',
        deleteAll: 'Cancellare TUTTI gli allenamenti?',
        noWorkouts: 'Nessun allenamento',
        monthNames: ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'],
        dayNames: ['Dom','Lun','Mar','Mer','Gio','Ven','Sab']
    },
    en: {
        title: 'üìÖ WORKOUT DIARY',
        subtitle: 'Auto-tracking ‚Ä¢ Visual calendar ‚Ä¢ Export to Google Calendar',
        totalWorkouts: 'Total Workouts',
        completedSessions: 'completed sessions',
        thisWeek: 'This Week',
        weekGoal: 'out of 4 goal',
        streak: 'Streak',
        consecutiveDays: 'consecutive days',
        totalRounds: 'Total Rounds',
        completedRounds: 'completed rounds',
        today: 'Today',
        exportGoogle: 'üìÖ Google Calendar',
        exportIcal: 'üìÜ iCal/Outlook',
        exportJson: '‚¨áÔ∏è JSON',
        clearData: 'üóëÔ∏è Clear',
        recentWorkouts: 'üìù Recent Workouts',
        timer: '‚è±Ô∏è Timer',
        program: 'üìÑ Program',
        noWorkout: 'No workout on',
        workoutsOn: 'Workouts on',
        noWorkoutYet: 'No workouts yet',
        completeFirst: 'Complete your first workout from the timer!',
        deleteAll: 'Delete ALL workouts?',
        noWorkouts: 'No workouts',
        monthNames: ['January','February','March','April','May','June','July','August','September','October','November','December'],
        dayNames: ['Sun','Mon','Tue','Wed','Thu','Fri','Sat']
    }
};

let currentLang = localStorage.getItem('tabataLang') || 'it';

function setLanguage(lang) {
    currentLang = lang;
    localStorage.setItem('tabataLang', lang);
    
    // Update buttons
    document.getElementById('langIT').style.background = lang === 'it' ? '#00ff00' : '#333';
    document.getElementById('langIT').style.borderColor = lang === 'it' ? '#00ff00' : '#555';
    document.getElementById('langEN').style.background = lang === 'en' ? '#00ff00' : '#333';
    document.getElementById('langEN').style.borderColor = lang === 'en' ? '#00ff00' : '#555';
    
    // Update all elements with data-i18n
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (translations[lang][key]) {
            el.textContent = translations[lang][key];
        }
    });
    
    // Re-render calendar with translated months/days
    renderCalendar();
}

document.getElementById('langIT').addEventListener('click', () => setLanguage('it'));
document.getElementById('langEN').addEventListener('click', () => setLanguage('en'));

// Initialize
setLanguage(currentLang);
</script>
</body>
</html>
